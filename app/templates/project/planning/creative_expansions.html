{% extends "base.html" %}

{% block content %}
<div class="content-section">
    <h2>创意发散 - {{ project.title }}</h2>
    
    <!-- 原始灵感展示 -->
    <div class="card mb-4">
        <div class="card-header">
            原始灵感
        </div>
        <div class="card-body">
            <p class="card-text">{{ initial_idea.content }}</p>
            <p class="card-text">
                <small class="text-muted">
                    来源: {{ {
                        'real_event': '真实事件',
                        'fictional_world': '虚构世界',
                        'theme': '主题表达',
                        'viewpoint': '观点表达',
                        'other': '其他'
                    }[initial_idea.source_type] }}
                </small>
            </p>
            <div class="text-right">
                <button id="generateMoreExpansions" class="btn btn-outline-primary">
                    生成更多创意
                </button>
            </div>
        </div>
    </div>
    
    <!-- 生成创意按钮 -->
    {% if not expansions %}
    <div class="text-center mb-4">
        <button id="generateExpansions" class="btn btn-lg btn-primary">
            生成创意发散
        </button>
    </div>
    {% endif %}
    
    <!-- 创意列表 -->
    <div id="expansionsList">
        {% for expansion in expansions %}
        <div class="card mb-4 {% if expansion.is_selected %}border-success{% endif %}">
            <div class="card-header {% if expansion.is_selected %}bg-success text-white{% endif %}">
                创意 #{{ loop.index }}
                {% if expansion.is_selected %}
                <span class="badge badge-light float-right">已选择</span>
                {% endif %}
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ expansion.summary }}</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>体裁:</strong> {{ expansion.genre }}
                    </div>
                    <div class="col-md-8">
                        <strong>主题:</strong> {{ expansion.theme }}
                    </div>
                </div>
                <div class="card-text mb-3">
                    <strong>创新点:</strong><br>
                    {{ expansion.innovation_points }}
                </div>
                
                {% if expansion.has_concept %}
                    <a href="{{ url_for('project_planning.basic_concept', project_id=project.id, expansion_id=expansion.id) }}" 
                       class="btn btn-info">查看全文构思</a>
                {% elif expansion.is_selected %}
                    <button class="btn btn-primary generate-concept" 
                            data-expansion-id="{{ expansion.id }}">
                        生成全文构思
                    </button>
                {% else %}
                    <button class="btn btn-success select-expansion" 
                            data-expansion-id="{{ expansion.id }}">
                        选择此创意
                    </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    // 绑定选择创意按钮事件
    function bindSelectExpansion() {
        $('.select-expansion').off('click').on('click', function() {
            var $btn = $(this);
            var expansionId = $btn.data('expansion-id');
            
            $btn.prop('disabled', true).html(
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 选择中...'
            );
            
            $.ajax({
                url: "{{ url_for('project_planning.select_expansion', project_id=project.id, expansion_id=0) }}".replace('/0', '/' + expansionId),
                method: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        // 更新按钮状态和样式
                        var $card = $btn.closest('.card');
                        $card.addClass('border-success');
                        $card.find('.card-header').addClass('bg-success text-white').append(
                            '<span class="badge badge-light float-right">已选择</span>'
                        );
                        $btn.replaceWith(`
                            <button class="btn btn-primary generate-concept" 
                                    data-expansion-id="${expansionId}">
                                生成全文构思
                            </button>
                        `);
                        // 绑定新的生成全文构思按钮事件
                        bindGenerateConcept();
                    } else {
                        alert('选择失败：' + response.error);
                        $btn.prop('disabled', false).text('选择此创意');
                    }
                },
                error: function(xhr) {
                    alert('选择失败: ' + (xhr.responseJSON?.error || '未知错误'));
                    $btn.prop('disabled', false).text('选择此创意');
                }
            });
        });
    }
    
    // 绑定生成全文构思按钮事件
    function bindGenerateConcept() {
        $('.generate-concept').off('click').on('click', function() {
            var $btn = $(this);
            var expansionId = $btn.data('expansion-id');
            
            $btn.prop('disabled', true).html(
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 构思生成中...'
            );
            
            $.ajax({
                url: "{{ url_for('project_planning.basic_concept', project_id=project.id, expansion_id=0) }}".replace('/0', '/' + expansionId),
                method: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        window.location.href = "{{ url_for('project_planning.basic_concept', project_id=project.id, expansion_id=0) }}".replace('/0', '/' + expansionId);
                    } else {
                        alert('生成失败: ' + response.error);
                        $btn.prop('disabled', false).text('生成全文构思');
                    }
                },
                error: function(xhr) {
                    alert('生成失败: ' + (xhr.responseJSON?.error || '未知错误'));
                    $btn.prop('disabled', false).text('生成全文构思');
                }
            });
        });
    }
    
    // 初始绑定事件
    bindSelectExpansion();
    bindGenerateConcept();
    
    // 生成创意发散
    $('#generateExpansions, #generateMoreExpansions').on('click', function() {
        var $btn = $(this);
        var originalText = $btn.is('#generateMoreExpansions') ? '生成更多创意' : '生成创意发散';
        $btn.prop('disabled', true).html(
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...'
        );
        
        $.ajax({
            url: "{{ url_for('project_planning.creative_expansions', project_id=project.id, idea_id=initial_idea.id) }}",
            method: 'POST',
            success: function(response) {
                if (response.status === 'success') {
                    // 如果是"生成更多创意"，动态插入新创意卡片
                    if (response.new_expansions && response.new_expansions.length > 0) {
                        var $expansionsList = $('#expansionsList');
                        response.new_expansions.forEach(function(expansion, index) {
                            var nextIndex = $expansionsList.children().length + index + 1;
                            var cardHtml = `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        创意 #${nextIndex}
                                    </div>
                                    <div class="card-body">
                                        <h5 class="card-title">${expansion.summary}</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <strong>体裁:</strong> ${expansion.genre}
                                            </div>
                                            <div class="col-md-8">
                                                <strong>主题:</strong> ${expansion.theme}
                                            </div>
                                        </div>
                                        <div class="card-text mb-3">
                                            <strong>创新点:</strong><br>
                                            ${expansion.innovation_points}
                                        </div>
                                        <button class="btn btn-success select-expansion" 
                                                data-expansion-id="${expansion.id}">
                                            选择此创意
                                        </button>
                                    </div>
                                </div>
                            `;
                            $expansionsList.prepend(cardHtml);
                        });
                        
                        // 重新绑定选择按钮事件
                        bindSelectExpansion();
                    } else if ($('#expansionsList').children().length === 0) {
                        // 如果是第一次生成，刷新页面
                        location.reload();
                    }
                } else {
                    alert('生成失败：' + response.error);
                }
            },
            error: function(xhr) {
                alert('生成失败: ' + (xhr.responseJSON?.error || '未知错误'));
                $btn.prop('disabled', false).text(originalText);
            }
        });
    });
    
});
</script>
{% endblock %}

{% endblock %}